<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>luker.dev | Testing Visual Studio Code Extensions</title>
  <meta name="author" content="Ryan Luker">
  <meta name="description" content="Testing Visual Studio Code Extensions">
  <link rel="stylesheet" type="text/css" href="/basic.css">
</head>

<body>
  <div>
    <h1>
      <a href="/home">luker.dev</a>
    </h1>
  </div>
  <h3>How to unit test vscode extensions with basic mocks</h3>
  <p>
    One of the major tools in any testers toolbelt is the mighty module mock.
    So when I started looking into adding proper unit tests to my vscode extension,
    I surprisingly had quite a difficult time finding something that would work gracefully
    with vscode's test harness.

    Seeming I have also been tinkering with go and the absolutely
    fantastic gitbook <abbr>learn-go-with-tests</abbr><sup><a href="#1">1</a></sup>,
    I decided to try my hand at creating a simple mocking structure for
    <abbr>vscode-coverage-gutters</abbr><sup><a href="#2">2</a></sup>.
    This was in contrast to using something established like <abbr>sinon</abbr><sup><a href="#3">3</a></sup>.

    Big warning before I dive in though, this implementation works well for this specific use case but should
    not be taken as vscode extension testing gospel!
  </p>
  <p>
    Let's quickly breakdown the problem before we go into our very basic mocking implementation.
  </p>
  <ol>
    <li>We need a way to mock module functionality that are used inside our extension (vscode, requests, etc).</li>
    <li>We need to swap the current functionality of the module with our test expectation</li>
    <li>Once we have completed a test case, we need to clean up after ourselves to prevent test leakage.</li>
  </ol>
  <p>
    Alright, with our requirements outlined let's dive in! The first critical piece of understanding is how we
    can mock modules inside the test case without directly affecting the piece of code under test. This is where
    having an understanding of the nodejs import <abbr>caching system<sup><a href="#4">4</a></sup></abbr>
    comes into play. Using the cache ,to effect extension wide changes, we can do something like this for mocking
    the <b>fs.readFile</b>.
  </p>
  <script src="https://gist.github.com/ryanluker/bba7808e3b1bbd5fe33da8936731ec73.js"></script>
  <p>
    Let' break this example up a bit so we can understand the 3 stages of the module mocking.
    In the first stage we store the original function so that we can “restore” this module to an original state later.
    You can see this restoring action in the teardown snippet, which runs after each test case has been completed.
    Next we see us changing the functionality of the readFile.
  </p>
  <p>
    After this point any call to <b>fs.readFile</b> in any code flow, we really only care about the functionality under test
    though, will utilise the test function defined just above.
    This state will persist for the rest of test case until the teardown is called and restores the stored original
    functionality.
  </p>
  <p>
    You can find this and more mocking examples 
    <a href="https://github.com/ryanluker/vscode-coverage-gutters/pull/218/files">here</a>.
    Wrapping up, we see that using the node module caching allows us to “swap” out functionality of specific modules for
    mock flows that help us verify code under test. This clean approach of storing the original functionality, modifying
    the functionality with a mock and finally restoring the module to an original state, feels like quick a succinct
    pattern. Also it allows us to accomplish our main goal of testing exactly the conditional nuance we want in each
    test case.
  </p>
  <p>
    I love to discuss technical implementations so drop a comment in the
    <a href="https://github.com/ryanluker/luker.dev/discussions/13">github discussion</a>
    if you have any advice or questions!
  </p>
  <h3>References</h3>
  <ol>
    <li>
      learn-go-with-tests: <a href="https://quii.gitbook.io/learn-go-with-tests/"
        id="1">https://quii.gitbook.io/learn-go-with-tests/</a>
    </li>
    <li>
      vscode-coverage-gutters: <a href="https://github.com/ryanluker/vscode-coverage-gutters"
        id="2">https://github.com/ryanluker/vscode-coverage-gutters</a>
    </li>
    <li>
      SinonJS: <a href="https://sinonjs.org" id="3">https://sinonjs.org</a>
    </li>
    <li>
      Caching System: <a href="https://nodejs.org/api/modules.html#modules_caching"
        id="4">https://nodejs.org/api/modules.html#modules_caching</a>
    </li>
  </ol>
</body>

</html>